name: Release Management

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  REGISTRY: docker.io
  IMAGE_NAME: skygenesisenterprise/notploy

jobs:
  # Validation de la version
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-prerelease"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          echo "âœ… Version validated: $VERSION"

  # CrÃ©ation du changelog
  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: [validate-version]
    if: always()
    
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install conventional-changelog
        run: npm install -g conventional-changelog-cli

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.validate-version.outputs.version || github.ref_name }}"
          
          # Extraire le numÃ©ro de version du tag
          if [[ $VERSION == refs/tags/* ]]; then
            VERSION=${VERSION#refs/tags/}
          fi
          
          # GÃ©nÃ©rer le changelog depuis le dernier tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(conventional-changelog -p angular -i CHANGELOG.md -s --first-release)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "## $VERSION" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### Features" >> $GITHUB_OUTPUT
            echo "- Initial release" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Upload changelog
        uses: actions/upload-artifact@v3
        with:
          name: changelog
          path: CHANGELOG.md

  # Build des assets de release
  build-release:
    name: Build Release Assets
    runs-on: ${{ matrix.os }}
    needs: [validate-version]
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            arch: amd64
            ext: tar.gz
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            ext: tar.gz
          - os: macos-latest
            platform: darwin
            arch: amd64
            ext: tar.gz
          - os: macos-latest
            platform: darwin
            arch: arm64
            ext: tar.gz
          - os: windows-latest
            platform: windows
            arch: amd64
            ext: zip
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build applications
        run: |
          pnpm run build

      - name: Create binary for ${{ matrix.platform }}-${{ matrix.arch }}
        shell: bash
        run: |
          VERSION="${{ needs.validate-version.outputs.version || github.ref_name }}"
          VERSION=${VERSION#refs/tags/}
          
          mkdir -p release
          
          # CrÃ©er le nom de fichier
          FILENAME="notploy-${VERSION}-${{ matrix.platform }}-${{ matrix.arch }}"
          
          if [ "${{ matrix.platform }}" = "windows" ]; then
            # Pour Windows, crÃ©er un ZIP
            cd apps/dokploy/dist
            zip -r "../../../release/${FILENAME}.zip" .
            cd ../../../
            
            # CrÃ©er le checksum
            cd release
            sha256sum "${FILENAME}.zip" > "${FILENAME}.zip.sha256"
            cd ..
          else
            # Pour Linux et macOS, crÃ©er un tar.gz
            tar -czf "release/${FILENAME}.${{ matrix.ext }}" -C apps/dokploy/dist .
            
            # CrÃ©er le checksum
            cd release
            sha256sum "${FILENAME}.${{ matrix.ext }}" > "${FILENAME}.${{ matrix.ext }}.sha256"
            cd ..
          fi
          
          echo "Created ${FILENAME}.${{ matrix.ext }}"

      - name: Upload release assets
        uses: actions/upload-artifact@v3
        with:
          name: release-assets-${{ matrix.platform }}-${{ matrix.arch }}
          path: release/

  # Build et push des images Docker
  docker-release:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: [validate-version]
    
    strategy:
      matrix:
        service: [dokploy, api, schedules, monitoring]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}:${{ needs.validate-version.outputs.version }}
          format: spdx-json
          output-file: sbom-${{ matrix.service }}.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v3
        with:
          name: sbom-${{ matrix.service }}
          path: sbom-${{ matrix.service }}.json

  # Tests de la release
  test-release:
    name: Test Release
    runs-on: ubuntu-latest
    needs: [build-release, docker-release]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release assets
        uses: actions/download-artifact@v3
        with:
          pattern: release-assets-*
          merge-multiple: true

      - name: Download Docker images
        run: |
          VERSION="${{ needs.validate-version.outputs.version || github.ref_name }}"
          VERSION=${VERSION#refs/tags/}
          
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/dokploy:$VERSION
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:$VERSION
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/schedules:$VERSION

      - name: Test Docker images
        run: |
          VERSION="${{ needs.validate-version.outputs.version || github.ref_name }}"
          VERSION=${VERSION#refs/tags/}
          
          # Tester que les images dÃ©marrent correctement
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/dokploy:$VERSION --version || exit 1
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:$VERSION --version || exit 1
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/schedules:$VERSION --version || exit 1

      - name: Test release archives
        run: |
          VERSION="${{ needs.validate-version.outputs.version || github.ref_name }}"
          VERSION=${VERSION#refs/tags/}
          
          # Extraire et tester l'archive
          tar -xzf notploy-${VERSION}-linux-amd64.tar.gz
          ls -la
          
          # VÃ©rifier que les fichiers essentiels sont prÃ©sents
          if [ ! -f "server.js" ]; then
            echo "âŒ server.js not found in release"
            exit 1
          fi

  # CrÃ©ation de la release GitHub
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-version, changelog, build-release, docker-release, test-release]
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          VERSION="${{ needs.validate-version.outputs.version || github.ref_name }}"
          VERSION=${VERSION#refs/tags/}
          
          mkdir -p release-assets
          
          # Copier les assets des builds (toutes les plateformes)
          find artifacts/release-assets-* -name "*.tar.gz" -exec cp {} release-assets/ \;
          find artifacts/release-assets-* -name "*.zip" -exec cp {} release-assets/ \;
          find artifacts/release-assets-* -name "*.sha256" -exec cp {} release-assets/ \;
          
          # Copier les SBOMs
          find artifacts/sbom-* -name "*.json" -exec cp {} release-assets/ \;
          
          # Copier le changelog
          cp artifacts/changelog/CHANGELOG.md release-assets/ || echo "No changelog found"
          
          # CrÃ©er un fichier d'installation
          cat > release-assets/INSTALL.md << 'EOF'
          # Installation de Notploy vVERSION
          
          ## Docker Hub (RecommandÃ©)
          
          ### Images disponibles
          - `skygenesisenterprise/notploy:vx.x.x` - Application principale
          - `skygenesisenterprise/notploy-api:vx.x.x` - API de dÃ©ploiement
          - `skygenesisenterprise/notploy-schedules:vx.x.x` - Service de planification
          - `skygenesisenterprise/notploy-monitoring:vx.x.x` - Monitoring
          
          ### Docker Compose
          ```yaml
          version: '3.8'
          services:
            app:
              image: skygenesisenterprise/notploy:vx.x.x
              ports:
                - "3000:3000"
              environment:
                - DATABASE_URL=postgresql://...
                - NEXTAUTH_SECRET=your-secret
              
            api:
              image: skygenesisenterprise/notploy-api:vx.x.x
              ports:
                - "3001:3001"
              environment:
                - DATABASE_URL=postgresql://...
              
            schedules:
              image: skygenesisenterprise/notploy-schedules:vx.x.x
              environment:
                - REDIS_URL=redis://redis:6379
              
            redis:
              image: redis:7-alpine
              
            postgres:
              image: postgres:15
              environment:
                POSTGRES_DB: notploy
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: password
          ```
          
          ## Binaires natifs
          
          TÃ©lÃ©chargez le binaire correspondant Ã  votre plateforme :
          
          ### Linux
          - [Linux AMD64](notploy-vVERSION-linux-amd64.tar.gz)
          - [Linux ARM64](notploy-vVERSION-linux-arm64.tar.gz)
          
          ### macOS
          - [macOS AMD64](notploy-vVERSION-darwin-amd64.tar.gz)
          - [macOS ARM64 (Apple Silicon)](notploy-vVERSION-darwin-arm64.tar.gz)
          
          ### Windows
          - [Windows AMD64](notploy-vVERSION-windows-amd64.zip)
          
          ### Installation des binaires
          
          #### Linux/macOS
          ```bash
          # TÃ©lÃ©charger et extraire
          wget https://github.com/skygenesisenterprise/notploy/releases/download/vVERSION/notploy-vVERSION-linux-amd64.tar.gz
          tar -xzf notploy-vVERSION-linux-amd64.tar.gz
          
          # Rendre exÃ©cutable
          chmod +x notploy
          
          # DÃ©marrer
          ./notploy
          ```
          
          #### Windows
          ```powershell
          # TÃ©lÃ©charger et extraire
          Invoke-WebRequest -Uri "https://github.com/skygenesisenterprise/notploy/releases/download/vVERSION/notploy-vVERSION-windows-amd64.zip" -OutFile "notploy.zip"
          Expand-Archive -Path "notploy.zip" -DestinationPath "."
          
          # DÃ©marrer
          .\notploy.exe
          ```
          
          ## VÃ©rification de l'installation
          
          VÃ©rifiez l'intÃ©gritÃ© des fichiers tÃ©lÃ©chargÃ©s avec les checksums SHA256 :
          ```bash
          sha256sum -c notploy-vVERSION-linux-amd64.tar.gz.sha256
          ```
          
          ## Support
          
          - Documentation: https://github.com/skygenesisenterprise/notploy/docs
          - Issues: https://github.com/skygenesisenterprise/notploy/issues
          - Discussions: https://github.com/skygenesisenterprise/notploy/discussions
          EOF
          
          # Remplacer la version dans le fichier d'installation
          sed -i "s/vVERSION/v$VERSION/g" release-assets/INSTALL.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate-version.outputs.version || github.ref_name }}
          name: Release ${{ needs.validate-version.outputs.version || github.ref_name }}
          body: |
            ${{ needs.changelog.outputs.changelog }}
            
            ## ðŸ³ Docker Images
            - `skygenesisenterprise/notploy:${{ needs.validate-version.outputs.version || github.ref_name }}`
            - `skygenesisenterprise/notploy-api:${{ needs.validate-version.outputs.version || github.ref_name }}`
            - `skygenesisenterprise/notploy-schedules:${{ needs.validate-version.outputs.version || github.ref_name }}`
            - `skygenesisenterprise/notploy-monitoring:${{ needs.validate-version.outputs.version || github.ref_name }}`
            
            ## ðŸ“¦ Installation
            
            ### Docker Compose
            ```yaml
            version: '3.8'
            services:
              app:
                image: skygenesisenterprise/notploy:${{ needs.validate-version.outputs.version || github.ref_name }}
                ports:
                  - "3000:3000"
                environment:
                  - DATABASE_URL=postgresql://...
                  - NEXTAUTH_SECRET=your-secret
              
              api:
                image: skygenesisenterprise/notploy-api:${{ needs.validate-version.outputs.version || github.ref_name }}
                ports:
                  - "3001:3001"
              
              schedules:
                image: skygenesisenterprise/notploy-schedules:${{ needs.validate-version.outputs.version || github.ref_name }}
                environment:
                  - REDIS_URL=redis://redis:6379
              
              redis:
                image: redis:7-alpine
              
              postgres:
                image: postgres:15
                environment:
                  POSTGRES_DB: notploy
                  POSTGRES_USER: postgres
                  POSTGRES_PASSWORD: password
            ```
            
            ### Binary
            Download the appropriate binary from the assets below.
            
            ## ðŸ” SBOM
            Software Bill of Materials (SBOM) files are included in the assets.
          files: |
            release-assets/*
          draft: false
          prerelease: ${{ needs.validate-version.outputs.is_prerelease || false }}
          generate_release_notes: true

  # DÃ©ploiement sur les registres externes
  deploy-registries:
    name: Deploy to External Registries
    runs-on: ubuntu-latest
    needs: [create-release]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    strategy:
      matrix:
        registry: [quay]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ${{ matrix.registry }}
        uses: docker/login-action@v3
        with:
          registry: ${{ matrix.registry == 'dockerhub' && 'docker.io' || 'quay.io' }}
          username: ${{ secrets[format('{0}_USERNAME', matrix.registry)] }}
          password: ${{ secrets[format('{0}_TOKEN', matrix.registry)] }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ matrix.registry == 'dockerhub' && format('{0}/notploy', secrets.DOCKERHUB_USERNAME) || format('quay.io/{0}/notploy', secrets.QUAY_USERNAME) }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push to ${{ matrix.registry }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.dokploy
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Notification de la release
  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always()
    
    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#releases'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: |
            ðŸš€ New release: ${{ needs.validate-version.outputs.version || github.ref_name }}
            
            Release notes: https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate-version.outputs.version || github.ref_name }}

      - name: Update documentation
        if: needs.create-release.result == 'success'
        run: |
          # Mettre Ã  jour la documentation avec la nouvelle version
          echo "Documentation update needed for version ${{ needs.validate-version.outputs.version || github.ref_name }}"

      - name: Create issue for next release
        if: needs.create-release.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Prepare for next release after ${{ needs.validate-version.outputs.version || github.ref_name }}`,
              body: `## Next Release Planning\n\n### Features to consider\n- [ ] Feature 1\n- [ ] Feature 2\n\n### Bug fixes\n- [ ] Bug fix 1\n\n### Technical debt\n- [ ] Refactor 1`,
              labels: ['release', 'planning']
            });